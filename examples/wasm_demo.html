<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ccxt-rust WASM Demo</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            padding: 20px;
            min-height: 100vh;
        }
        h1 {
            color: #00d4ff;
            margin-bottom: 20px;
        }
        h2 {
            color: #ff6b6b;
            margin: 20px 0 10px;
            font-size: 1.2em;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .status {
            padding: 10px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .status.loading { background: #2d2d44; color: #ffd93d; }
        .status.ready { background: #1e3a2f; color: #4ade80; }
        .status.error { background: #3a1e1e; color: #f87171; }

        .exchange-section {
            background: #16213e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .exchange-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        .exchange-name {
            font-size: 1.5em;
            color: #00d4ff;
        }
        button {
            background: #0f3460;
            color: #fff;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            transition: background 0.2s;
        }
        button:hover {
            background: #1a5490;
        }
        button:disabled {
            background: #333;
            cursor: not-allowed;
        }
        .ticker-display {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .ticker-item {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .ticker-label {
            color: #888;
            font-size: 12px;
            margin-bottom: 5px;
        }
        .ticker-value {
            font-size: 1.3em;
            font-weight: bold;
            color: #4ade80;
        }
        .ticker-value.negative {
            color: #f87171;
        }
        .orderbook {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 15px;
        }
        .orderbook-side {
            background: #0f3460;
            padding: 15px;
            border-radius: 8px;
        }
        .orderbook-title {
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        .orderbook-title.bids { color: #4ade80; }
        .orderbook-title.asks { color: #f87171; }
        .orderbook-row {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            font-family: monospace;
            font-size: 13px;
        }
        .log-container {
            background: #0d1b2a;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            font-family: monospace;
            font-size: 12px;
            padding: 5px 0;
            border-bottom: 1px solid #1a1a2e;
        }
        .log-entry.info { color: #4ade80; }
        .log-entry.error { color: #f87171; }
        .log-entry.warn { color: #ffd93d; }

        .version-info {
            color: #666;
            font-size: 12px;
            margin-top: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü¶Ä ccxt-rust WASM Demo</h1>

        <div id="status" class="status loading">Loading WASM module...</div>

        <!-- Binance Section -->
        <div class="exchange-section">
            <div class="exchange-header">
                <span class="exchange-name">üî∂ Binance</span>
                <div>
                    <button onclick="fetchBinanceTicker()">Fetch BTC/USDT</button>
                    <button onclick="fetchBinanceOrderBook()">Fetch OrderBook</button>
                </div>
            </div>
            <div id="binance-ticker" class="ticker-display"></div>
            <div id="binance-orderbook" class="orderbook"></div>
        </div>

        <!-- Upbit Section -->
        <div class="exchange-section">
            <div class="exchange-header">
                <span class="exchange-name">üá∞üá∑ Upbit</span>
                <div>
                    <button onclick="fetchUpbitTicker()">Fetch BTC/KRW</button>
                    <button onclick="fetchUpbitOrderBook()">Fetch OrderBook</button>
                </div>
            </div>
            <div id="upbit-ticker" class="ticker-display"></div>
            <div id="upbit-orderbook" class="orderbook"></div>
        </div>

        <!-- Bybit Section -->
        <div class="exchange-section">
            <div class="exchange-header">
                <span class="exchange-name">‚ö° Bybit</span>
                <div>
                    <button onclick="fetchBybitTicker()">Fetch BTC/USDT</button>
                    <button onclick="fetchBybitOrderBook()">Fetch OrderBook</button>
                </div>
            </div>
            <div id="bybit-ticker" class="ticker-display"></div>
            <div id="bybit-orderbook" class="orderbook"></div>
        </div>

        <!-- WebSocket Section -->
        <h2>üîå WebSocket Streaming</h2>
        <div class="exchange-section">
            <div class="exchange-header">
                <span class="exchange-name">üì° Real-time Streams</span>
                <div>
                    <button onclick="startBinanceWs()">Binance Ticker</button>
                    <button onclick="startBybitWs()">Bybit Ticker</button>
                    <button onclick="stopAllWs()">Stop All</button>
                </div>
            </div>
            <div id="ws-stream" class="ticker-display">
                <div class="ticker-item" style="grid-column: span 3;">
                    <div class="ticker-label">WebSocket Status</div>
                    <div class="ticker-value" id="ws-status">Not connected</div>
                </div>
            </div>
            <div id="ws-data" class="ticker-display"></div>
        </div>

        <h2>üìã Console Log</h2>
        <div id="log" class="log-container"></div>

        <div id="version-info" class="version-info"></div>
    </div>

    <script type="module">
        import init, {
            version,
            getSupportedExchanges,
            WasmBinance,
            WasmUpbit,
            WasmBybit,
            WasmBinanceWs,
            WasmBybitWs,
            WasmUpbitWs,
            WasmExchangeConfig
        } from '../pkg/ccxt_rust.js';

        // Global instances
        let binance, upbit, bybit;

        // Logger
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.insertBefore(entry, logEl.firstChild);
            console.log(message);
        }

        // Status update
        function setStatus(message, type) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // Format number
        function formatNumber(num, decimals = 2) {
            if (num === null || num === undefined) return '-';
            return Number(num).toLocaleString(undefined, {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            });
        }

        // Display ticker
        function displayTicker(elementId, ticker) {
            const el = document.getElementById(elementId);
            el.innerHTML = `
                <div class="ticker-item">
                    <div class="ticker-label">Symbol</div>
                    <div class="ticker-value">${ticker.symbol}</div>
                </div>
                <div class="ticker-item">
                    <div class="ticker-label">Last Price</div>
                    <div class="ticker-value">${formatNumber(ticker.last, 2)}</div>
                </div>
                <div class="ticker-item">
                    <div class="ticker-label">Bid</div>
                    <div class="ticker-value">${formatNumber(ticker.bid, 2)}</div>
                </div>
                <div class="ticker-item">
                    <div class="ticker-label">Ask</div>
                    <div class="ticker-value">${formatNumber(ticker.ask, 2)}</div>
                </div>
                <div class="ticker-item">
                    <div class="ticker-label">High 24h</div>
                    <div class="ticker-value">${formatNumber(ticker.high, 2)}</div>
                </div>
                <div class="ticker-item">
                    <div class="ticker-label">Low 24h</div>
                    <div class="ticker-value">${formatNumber(ticker.low, 2)}</div>
                </div>
                <div class="ticker-item">
                    <div class="ticker-label">Volume 24h</div>
                    <div class="ticker-value">${formatNumber(ticker.volume, 4)}</div>
                </div>
            `;
        }

        // Display orderbook
        function displayOrderBook(elementId, orderbook) {
            const el = document.getElementById(elementId);
            const bids = JSON.parse(orderbook.getBids()).slice(0, 10);
            const asks = JSON.parse(orderbook.getAsks()).slice(0, 10);

            el.innerHTML = `
                <div class="orderbook-side">
                    <div class="orderbook-title bids">Bids (Buy Orders)</div>
                    ${bids.map(b => `
                        <div class="orderbook-row">
                            <span style="color: #4ade80">${formatNumber(b[0], 2)}</span>
                            <span>${formatNumber(b[1], 6)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="orderbook-side">
                    <div class="orderbook-title asks">Asks (Sell Orders)</div>
                    ${asks.map(a => `
                        <div class="orderbook-row">
                            <span style="color: #f87171">${formatNumber(a[0], 2)}</span>
                            <span>${formatNumber(a[1], 6)}</span>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // Binance functions
        window.fetchBinanceTicker = async function() {
            try {
                log('Fetching Binance BTC/USDT ticker...');
                const ticker = await binance.fetchTicker('BTC/USDT');
                displayTicker('binance-ticker', ticker);
                log(`Binance BTC/USDT: $${formatNumber(ticker.last, 2)}`, 'info');
            } catch (e) {
                log(`Binance error: ${e}`, 'error');
            }
        };

        window.fetchBinanceOrderBook = async function() {
            try {
                log('Fetching Binance BTC/USDT orderbook...');
                const orderbook = await binance.fetchOrderBook('BTC/USDT', 20);
                displayOrderBook('binance-orderbook', orderbook);
                log('Binance orderbook fetched', 'info');
            } catch (e) {
                log(`Binance error: ${e}`, 'error');
            }
        };

        // Upbit functions
        window.fetchUpbitTicker = async function() {
            try {
                log('Fetching Upbit BTC/KRW ticker...');
                const ticker = await upbit.fetchTicker('BTC/KRW');
                displayTicker('upbit-ticker', ticker);
                log(`Upbit BTC/KRW: ‚Ç©${formatNumber(ticker.last, 0)}`, 'info');
            } catch (e) {
                log(`Upbit error: ${e}`, 'error');
            }
        };

        window.fetchUpbitOrderBook = async function() {
            try {
                log('Fetching Upbit BTC/KRW orderbook...');
                const orderbook = await upbit.fetchOrderBook('BTC/KRW', 15);
                displayOrderBook('upbit-orderbook', orderbook);
                log('Upbit orderbook fetched', 'info');
            } catch (e) {
                log(`Upbit error: ${e}`, 'error');
            }
        };

        // Bybit functions
        window.fetchBybitTicker = async function() {
            try {
                log('Fetching Bybit BTC/USDT ticker...');
                const ticker = await bybit.fetchTicker('BTC/USDT');
                displayTicker('bybit-ticker', ticker);
                log(`Bybit BTC/USDT: $${formatNumber(ticker.last, 2)}`, 'info');
            } catch (e) {
                log(`Bybit error: ${e}`, 'error');
            }
        };

        window.fetchBybitOrderBook = async function() {
            try {
                log('Fetching Bybit BTC/USDT orderbook...');
                const orderbook = await bybit.fetchOrderBook('BTC/USDT', 25);
                displayOrderBook('bybit-orderbook', orderbook);
                log('Bybit orderbook fetched', 'info');
            } catch (e) {
                log(`Bybit error: ${e}`, 'error');
            }
        };

        // WebSocket instances
        let binanceWs, bybitWs, upbitWs;
        let wsActive = false;

        // WebSocket callback handler
        function handleWsMessage(msg) {
            const statusEl = document.getElementById('ws-status');
            const dataEl = document.getElementById('ws-data');

            if (msg.message_type === 'connected') {
                statusEl.textContent = `Connected (${msg.symbol})`;
                statusEl.style.color = '#4ade80';
                log(`WebSocket connected: ${msg.symbol}`, 'info');
            } else if (msg.message_type === 'disconnected') {
                statusEl.textContent = 'Disconnected';
                statusEl.style.color = '#f87171';
                log('WebSocket disconnected', 'warn');
            } else if (msg.message_type === 'error') {
                statusEl.textContent = 'Error';
                statusEl.style.color = '#f87171';
                log(`WebSocket error: ${msg.data}`, 'error');
            } else if (msg.message_type === 'ticker') {
                try {
                    const data = JSON.parse(msg.data);
                    // Binance ticker format
                    const price = data.c || data.lastPrice || data.last;
                    const high = data.h || data.highPrice24h;
                    const low = data.l || data.lowPrice24h;
                    const volume = data.v || data.volume24h;

                    dataEl.innerHTML = `
                        <div class="ticker-item">
                            <div class="ticker-label">Symbol</div>
                            <div class="ticker-value">${msg.symbol}</div>
                        </div>
                        <div class="ticker-item">
                            <div class="ticker-label">Last Price</div>
                            <div class="ticker-value">${formatNumber(parseFloat(price), 2)}</div>
                        </div>
                        <div class="ticker-item">
                            <div class="ticker-label">High 24h</div>
                            <div class="ticker-value">${formatNumber(parseFloat(high), 2)}</div>
                        </div>
                        <div class="ticker-item">
                            <div class="ticker-label">Low 24h</div>
                            <div class="ticker-value">${formatNumber(parseFloat(low), 2)}</div>
                        </div>
                        <div class="ticker-item">
                            <div class="ticker-label">Volume 24h</div>
                            <div class="ticker-value">${formatNumber(parseFloat(volume), 4)}</div>
                        </div>
                        <div class="ticker-item">
                            <div class="ticker-label">Updated</div>
                            <div class="ticker-value">${new Date().toLocaleTimeString()}</div>
                        </div>
                    `;
                } catch (e) {
                    log(`Parse error: ${e}`, 'error');
                }
            }
        }

        // Start Binance WebSocket
        window.startBinanceWs = function() {
            try {
                if (wsActive) {
                    log('WebSocket already active. Stop first.', 'warn');
                    return;
                }
                log('Starting Binance WebSocket for BTC/USDT...');
                binanceWs = new WasmBinanceWs();
                binanceWs.watchTicker('BTC/USDT', handleWsMessage);
                wsActive = true;
                log('Binance WebSocket started', 'info');
            } catch (e) {
                log(`Binance WS error: ${e}`, 'error');
            }
        };

        // Start Bybit WebSocket
        window.startBybitWs = function() {
            try {
                if (wsActive) {
                    log('WebSocket already active. Stop first.', 'warn');
                    return;
                }
                log('Starting Bybit WebSocket for BTC/USDT...');
                bybitWs = new WasmBybitWs();
                bybitWs.watchTicker('BTC/USDT', handleWsMessage);
                wsActive = true;
                log('Bybit WebSocket started', 'info');
            } catch (e) {
                log(`Bybit WS error: ${e}`, 'error');
            }
        };

        // Stop all WebSocket connections
        window.stopAllWs = function() {
            wsActive = false;
            binanceWs = null;
            bybitWs = null;
            upbitWs = null;
            document.getElementById('ws-status').textContent = 'Stopped';
            document.getElementById('ws-status').style.color = '#888';
            document.getElementById('ws-data').innerHTML = '';
            log('All WebSocket connections stopped', 'info');
        };

        // Initialize
        async function main() {
            try {
                log('Initializing WASM module...');
                await init();

                const ver = version();
                const exchanges = JSON.parse(getSupportedExchanges());

                log(`ccxt-rust version: ${ver}`);
                log(`Supported exchanges: ${exchanges.length}`);

                // Create exchange instances
                binance = new WasmBinance();
                upbit = new WasmUpbit();
                bybit = new WasmBybit();

                log('Exchange instances created', 'info');

                setStatus(`‚úÖ WASM Ready - ccxt-rust v${ver}`, 'ready');
                document.getElementById('version-info').textContent =
                    `ccxt-rust v${ver} | ${exchanges.length} exchanges supported | WASM build`;

            } catch (e) {
                log(`Initialization error: ${e}`, 'error');
                setStatus(`‚ùå Error: ${e}`, 'error');
            }
        }

        main();
    </script>
</body>
</html>
